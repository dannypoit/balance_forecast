<body>
  <header>
    <h1>Balance Forecast</h1>
    <% if current_user %>
      <div class="dropdown d-inline">
        <a class="dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Settings
        </a>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          <%= link_to 'Change email or password', edit_user_registration_path(current_user), class: 'dropdown-item' %>
        </div>
      </div>
      <%= link_to "Log out", destroy_user_session_path, method: :delete %>
    <% else %>
      <%= link_to "Log In", new_user_session_path %>
    <% end %>
  </header>

  <main role="main">
    
    <div class="container">
      <% if notice.present? %>
        <div class="alert alert-info" role="alert"><%= notice %></div>
      <% end %>

      <% if alert.present? %>
        <div class="alert alert-danger" role="alert"><%= alert %></div>
      <% end %>

      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th class="top-row-cells"></th><th class="top-row-cells"></th><th class="top-row-cells"></th>
            <th class="text-right current-balance-label-cell" style="font-weight: 400;">
              Current balance:
            </th>
            <th class="h4">
              $<span data-editable id="currentBalance" data-user-id="<%= current_user.id %>"><%= (current_user.current_balance / 100.00).round %></span>
            </th>
          </tr>
          <tr class="header-row">
            <th scope="col">
              Date
            </th>
            <th scope="col">
              Description
            </th>
            <th scope="col">
              Frequency
            </th>
            <th scope="col">
              Amount
            </th>
            <th scope="col">
              Balance
            </th>
          </tr>
        </thead>
        <tbody>
          <tr class="new-entry-row">
          <%= form_for(@entry) do |f| %>
            <td>
              <%= f.date_field :date %>
            </td>
            <td>
              <%= f.text_field :description %>
            </td>
            <td>
              <%= f.text_field :frequency %> <!-- change to dropdown -->
            </td>
            <td>
              <%= f.number_field :amount %>
              <p class="text-muted small m-0">(in cents)</p>
            </td>
            <td>
              <%= f.submit 'Add', class: 'btn btn-primary' %>
            </td>
          <% end %>
          </tr>
        </tbody>
        <tbody class="entries-table">
        </tbody>
      </table>
    </div>
  </main>

  <footer>

  </footer>

  <script>
    $(function() {
      $.get("/entries").success(function(data) {
        var currentBalance = document.getElementById("currentBalance").innerHTML;
        var newBalance = parseInt(currentBalance);
        var allEntryRows = "";
        var userID = $('#currentBalance').data("user-id");

        $.each(data, function(index, entry) {
          newBalance = newBalance - Math.round(entry.amount / 100.00);
          var entryRow = '<tr><td>' + entry.date + '</td><td>' + entry.description + '</td><td>' + entry.frequency + '</td><td>$' + Math.round(entry.amount / 100.00) + '</td><td>$' + 
          newBalance
          + '</td><td class="entry-actions-cell"><input class="clear" type="checkbox"' + ' data-id="' + entry.id + '" data-user-id="' + entry.user_id + '" data-amount="' + Math.round(entry.amount / 100.00) + '"><i class="far fa-trash-alt ml-2"' + ' data-id="' + entry.id + '"></i></td></tr>';

          allEntryRows += entryRow;
        });

        var entriesTable = $('.entries-table');
        entriesTable.html(allEntryRows);

        $('body').on('click', '[data-editable]', function() {
          var $el = $(this);
          var $input = $('<input/>').val( $el.text() );
          $el.replaceWith( $input );
          
          var save = function(){
            var $p = $('<span data-editable id="currentBalance" />').text( $input.val() );
            $input.replaceWith( $p );

            updatedBalance = document.getElementById("currentBalance").innerHTML;
            
            $.post("/users/" + userID, {
              _method: "PUT",
              user: {
                current_balance: updatedBalance
              }
            });
          };
          
          $input.one('blur', save).focus();
        });

        $('.clear').change(function(e) {
          var entryID = $(e.target).data("id");

          var amount = $(e.target).data("amount");
          var updatedBalance = (currentBalance - amount) * 100;

          $.post("/users/" + userID, {
            _method: "PUT",
            user: {
              current_balance: updatedBalance
            }
          });

          $.ajax({
            type: "DELETE",
            url: "/entries/" + entryID
          });
        });

        $('.fa-trash-alt').click(function(e) {
          var entryID = $(e.target).data("id");

          $.ajax({
            type: "DELETE",
            url: "/entries/" + entryID
          });
        });
      });
    });
  </script>